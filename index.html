<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nano-task Fail-fast Checklist (Prototype)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #101824;
      --card: #0f1620;
      --card2: #0c121a;
      --text: #e6edf3;
      --muted: #a9b4c0;
      --border: rgba(230,237,243,0.12);
      --accent: #6aa6ff;
      --good: #4fd18b;
      --bad: #ff6b6b;
      --warn: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 10% -10%, rgba(106,166,255,0.14), transparent 60%),
                  radial-gradient(900px 700px at 90% 0%, rgba(79,209,139,0.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11,15,20,0.75);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 18px;
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
    }
    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title h1 {
      font-size: 16px;
      margin: 0;
      letter-spacing: 0.2px;
      font-weight: 800;
    }
    .title p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .search {
      width: min(420px, 44vw);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.55);
      color: var(--text);
      outline: none;
    }
    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.8);
      color: var(--text);
      cursor: pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      white-space: nowrap;
    }
    .btn:hover { border-color: rgba(106,166,255,0.45); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: rgba(106,166,255,0.35); }
    .btn.primary:hover { border-color: rgba(106,166,255,0.75); }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      padding-bottom: 90px;
    }

    /* Top navigation / progress bar */
    .topbar {
      border: 1px solid rgba(230,237,243,0.10);
      background: rgba(12,18,26,0.55);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .topbar .left {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 240px;
    }
    .topbar .right {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .progress {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .progress .count {
      font-size: 12px;
      color: var(--muted);
    }
    .progress .count strong {
      color: var(--text);
      font-weight: 900;
    }
    .dots {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      padding-top: 2px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(230,237,243,0.18);
      background: rgba(230,237,243,0.08);
      cursor: pointer;
      transition: transform 0.08s ease, border-color 0.2s ease;
    }
    .dot:hover { transform: translateY(-1px); border-color: rgba(106,166,255,0.55); }
    .dot.pass { background: rgba(79,209,139,0.75); border-color: rgba(79,209,139,0.45); }
    .dot.fail { background: rgba(255,107,107,0.75); border-color: rgba(255,107,107,0.45); }
    .dot.active { outline: 2px solid rgba(106,166,255,0.35); outline-offset: 2px; }

    .toggleMode {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.5);
      color: var(--muted);
      font-size: 12px;
      user-select: none;
    }
    .toggleMode button {
      border: 1px solid var(--border);
      background: rgba(12,18,26,0.55);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .toggleMode button.active {
      border-color: rgba(106,166,255,0.55);
      color: var(--accent);
    }

    /* Slide + list view containers */
    .view { display: none; }
    .view.active { display: block; }

    /* Slide card */
    .slide {
      position: relative;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,24,36,0.86), rgba(15,22,32,0.66));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Status accents */
    .slide.pass {
      border-color: rgba(79,209,139,0.40);
      box-shadow: 0 10px 30px rgba(79,209,139,0.08), var(--shadow);
    }
    .slide.fail {
      border-color: rgba(255,107,107,0.40);
      box-shadow: 0 10px 30px rgba(255,107,107,0.08), var(--shadow);
    }
    .slide.pass::before,
    .slide.fail::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.18;
    }
    .slide.pass::before {
      background: radial-gradient(800px 300px at 15% 0%, rgba(79,209,139,0.55), transparent 60%);
    }
    .slide.fail::before {
      background: radial-gradient(800px 300px at 15% 0%, rgba(255,107,107,0.55), transparent 60%);
    }

    .slide-header {
      padding: 18px 18px 12px 18px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(230,237,243,0.08);
      background: rgba(12,18,26,0.60);
    }

    .slide-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .slide-title h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.2px;
      line-height: 1.2;
    }
    .slide-title .what {
      margin: 0;
      font-size: 13px;
      color: rgba(230,237,243,0.80);
      line-height: 1.45;
    }

    .badges {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.55);
      font-size: 12px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }
    .pill strong { color: var(--text); font-weight: 900; }

    .statusPill {
      border-color: rgba(230,237,243,0.16);
      background: rgba(16,24,36,0.75);
      color: rgba(230,237,243,0.72);
    }
    .statusPill.pass { border-color: rgba(79,209,139,0.45); color: rgba(79,209,139,0.95); }
    .statusPill.fail { border-color: rgba(255,107,107,0.45); color: rgba(255,107,107,0.95); }
    .statusPill.unset { border-color: rgba(255,209,102,0.25); color: rgba(255,209,102,0.92); }

    .slide-body {
      padding: 14px 18px 18px 18px;
      display: grid;
      gap: 12px;
      position: relative;
    }

    .section {
      padding: 12px 12px;
      border: 1px solid rgba(230,237,243,0.10);
      background: rgba(12,18,26,0.55);
      border-radius: 14px;
    }
    .section .label {
      font-size: 11px;
      letter-spacing: 0.18px;
      text-transform: uppercase;
      color: rgba(230,237,243,0.62);
      margin-bottom: 8px;
      display: block;
    }
    .section p {
      margin: 0;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }

    .list {
      margin: 8px 0 0 18px;
      padding: 0;
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }
    .list li { margin: 5px 0; color: var(--muted); }

    .examples {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .example {
      border: 1px dashed rgba(230,237,243,0.18);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(15,22,32,0.45);
    }
    .example .exlabel {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18px;
      color: rgba(230,237,243,0.62);
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.6);
    }
    .badge.bad { color: var(--bad); border-color: rgba(255,107,107,0.35); }
    .badge.good { color: var(--good); border-color: rgba(79,209,139,0.35); }
    .example code {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      white-space: pre-wrap;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }

    .toggle {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(16,24,36,0.52);
    }
    .toggle button {
      border: 1px solid var(--border);
      background: rgba(12,18,26,0.55);
      color: var(--text);
      border-radius: 12px;
      padding: 7px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: border-color .2s ease, transform .05s ease;
    }
    .toggle button:hover { border-color: rgba(106,166,255,0.55); }
    .toggle button:active { transform: translateY(1px); }
    .toggle button.active.pass { border-color: rgba(79,209,139,0.55); color: var(--good); }
    .toggle button.active.fail { border-color: rgba(255,107,107,0.55); color: var(--bad); }
    .toggle button.active.unset { border-color: rgba(255,209,102,0.35); color: var(--warn); }

    .toggle .state {
      font-size: 12px;
      color: var(--muted);
      padding-left: 4px;
      white-space: nowrap;
    }

    /* Slide navigation buttons */
    .navBtns {
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }

    /* Wiki term styling */
    .term {
      color: var(--accent);
      cursor: pointer;
      border-bottom: 1px dashed rgba(106,166,255,0.45);
      text-decoration: none;
      padding-bottom: 1px;
    }
    .term:hover { border-bottom-color: rgba(106,166,255,0.9); }

    /* Tooltip */
    .tooltip {
      position: fixed;
      z-index: 1000;
      pointer-events: none;
      max-width: 320px;
      background: rgba(16,24,36,0.96);
      border: 1px solid rgba(230,237,243,0.14);
      border-radius: 12px;
      padding: 10px 10px;
      box-shadow: var(--shadow);
      display: none;
    }
    .tooltip .tt-title { font-weight: 900; font-size: 12px; margin-bottom: 4px; }
    .tooltip .tt-body { color: var(--muted); font-size: 12px; line-height: 1.35; }

    /* Right panel */
    .sidepanel {
      position: fixed;
      top: 0;
      right: -540px;
      width: min(540px, 92vw);
      height: 100vh;
      background: linear-gradient(180deg, rgba(16,24,36,0.98), rgba(12,18,26,0.98));
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 999;
      transition: right 0.18s ease;
      display: flex;
      flex-direction: column;
    }
    .sidepanel.open { right: 0; }
    .sidepanel header {
      position: sticky;
      top: 0;
      background: rgba(16,24,36,0.85);
      border-bottom: 1px solid rgba(230,237,243,0.10);
      backdrop-filter: blur(10px);
    }
    .sidepanel .sp-head {
      padding: 14px 14px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .sidepanel .sp-head h3 { margin: 0 0 4px 0; font-size: 14px; font-weight: 900; }
    .sidepanel .sp-head .sp-summary { margin: 0; font-size: 12px; color: var(--muted); line-height: 1.4; }
    .sidepanel .close {
      border: 1px solid var(--border);
      background: rgba(12,18,26,0.6);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .sidepanel .body {
      padding: 14px 14px 80px 14px;
      overflow: auto;
    }
    .sidepanel .body .md {
      font-size: 13px;
      line-height: 1.55;
      color: var(--text);
    }
    .sidepanel .body .md p { margin: 0 0 10px 0; }
    .sidepanel .body .md strong { font-weight: 900; }
    .sidepanel .body .md ul { margin: 8px 0 12px 20px; color: var(--muted); }
    .sidepanel .body .md li { margin: 4px 0; }
    .sidepanel .body .md code {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid rgba(230,237,243,0.12);
      border-radius: 10px;
      background: rgba(15,22,32,0.55);
      color: var(--text);
    }

    /* List view cards (overview) */
    .listCards { display: grid; gap: 12px; }
    .listCard {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,24,36,0.85), rgba(15,22,32,0.65));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .listCard.pass { border-color: rgba(79,209,139,0.40); }
    .listCard.fail { border-color: rgba(255,107,107,0.40); }

    /* Footer bar */
    .statusbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px 18px;
      border-top: 1px solid var(--border);
      background: rgba(11,15,20,0.78);
      backdrop-filter: blur(10px);
      z-index: 9;
    }
    .statusbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
      font-size: 12px;
    }
    .scoreMini strong { color: var(--text); font-weight: 900; }

    /* Lightweight loader */
    .loaderWrap {
      border: 1px solid rgba(230,237,243,0.10);
      background: rgba(12,18,26,0.55);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .loaderWrap code {
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid rgba(230,237,243,0.12);
      border-radius: 10px;
      background: rgba(15,22,32,0.55);
      color: var(--text);
    }
    .loaderWrap .err { color: var(--bad); }
    .loaderWrap .ok { color: var(--good); }

    @media (max-width: 820px) {
      .examples { grid-template-columns: 1fr; }
      .search { width: 70vw; }
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="title">
      <h1>Nano-task Fail-fast Checklist</h1>
    </div>
    <div class="controls">
      <input id="search" class="search" placeholder="Search checklist & wiki terms…" disabled />
      <button id="openNanoDef" class="btn primary" disabled>Open “Nano-task”</button>
      <button id="reset" class="btn" disabled>Reset</button>
    </div>
  </div>
</header>

<main class="layout">
  <div class="topbar">
    <div class="left">
      <div class="progress">
        <div class="count" id="progressText"></div>
        <div class="dots" id="dots"></div>
      </div>
    </div>
    <div class="right">
      <div class="navBtns">
        <button class="btn" id="prevBtn" disabled>← Prev</button>
        <button class="btn" id="nextBtn" disabled>Next →</button>
      </div>
      <div class="toggleMode">
        <span>View</span>
        <button id="modeSlide" class="active" disabled>Slide</button>
        <button id="modeList" disabled>List</button>
      </div>
    </div>
  </div>

  <div id="loader" class="loaderWrap">
    Loading <code>data.json</code>…
  </div>

  <section id="slideView" class="view active" style="display:none">
    <article class="slide" id="slide"></article>
  </section>

  <section id="listView" class="view" style="display:none">
    <div class="listCards" id="listCards"></div>
  </section>
</main>

<div class="tooltip" id="tooltip">
  <div class="tt-title" id="ttTitle"></div>
  <div class="tt-body" id="ttBody"></div>
</div>

<aside class="sidepanel" id="panel" aria-hidden="true">
  <header>
    <div class="sp-head">
      <div>
        <h3 id="panelTitle"></h3>
        <p class="sp-summary" id="panelSummary"></p>
      </div>
      <button class="close" id="panelClose">Close</button>
    </div>
  </header>
  <div class="body">
    <div class="md" id="panelBody"></div>
  </div>
</aside>

<div class="statusbar">
  <div class="statusbar-inner">
    <div class="scoreMini" id="scoreMini"></div>
    <div id="hint">Keyboard: ←/→ to navigate, Esc closes the wiki panel.</div>
  </div>
</div>

<script>
  // -----------------------------
  // Load data.json (static hosting friendly)
  // -----------------------------
  async function loadData() {
    // If you host under a subpath (GitHub Pages project site),
    // using a relative URL like "./data.json" is correct.
    const resp = await fetch("./data.json", { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status} when fetching data.json`);
    return await resp.json();
  }

  // -----------------------------
  // Utilities
  // -----------------------------
  function escapeHtml(s) {
    return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function getWiki(id) { return window.__NANO_DATA__?.wiki?.[id] || null; }

  function linkifyWikiRefs(text) {
    return (text || "").replace(/\[\[([^\]]+)\]\]/g, (_, id) => {
      const entry = getWiki(id.trim());
      const title = entry ? entry.title : id;
      return `<span class="term" data-term="${escapeHtml(id.trim())}">${escapeHtml(title)}</span>`;
    });
  }

  function renderWikiBody(body) {
    let html = escapeHtml(body || "");
    html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
    const lines = html.split("\n");
    let out = [];
    let inList = false;
    for (const raw of lines) {
      const line = raw.trim();
      if (!line) {
        if (inList) { out.push("</ul>"); inList = false; }
        continue;
      }
      if (line.startsWith("- ")) {
        if (!inList) { out.push("<ul>"); inList = true; }
        out.push(`<li>${linkifyWikiRefs(line.slice(2))}</li>`);
      } else {
        if (inList) { out.push("</ul>"); inList = false; }
        let p = line.replace(/`([^`]+)`/g, "<code>$1</code>");
        out.push(`<p>${linkifyWikiRefs(p)}</p>`);
      }
    }
    if (inList) out.push("</ul>");
    return out.join("\n");
  }

  function termSpan(termId, fallbackText) {
    const entry = getWiki(termId);
    const text = fallbackText || (entry ? entry.title : termId);
    return `<span class="term" data-term="${escapeHtml(termId)}">${escapeHtml(text)}</span>`;
  }

  function renderWikiChips(termIds) {
    if (!termIds?.length) return "";
    const chips = termIds.map(id => {
      const title = getWiki(id)?.title || id;
      return `<span class="pill" style="cursor:pointer" data-term="${escapeHtml(id)}"><strong>Wiki</strong> ${escapeHtml(title)}</span>`;
    });
    return `<div class="actions">${chips.join("")}</div>`;
  }

  // -----------------------------
  // Tooltip + Panel
  // -----------------------------
  const tooltip = document.getElementById("tooltip");
  const ttTitle = document.getElementById("ttTitle");
  const ttBody = document.getElementById("ttBody");
  const panel = document.getElementById("panel");
  const panelTitle = document.getElementById("panelTitle");
  const panelSummary = document.getElementById("panelSummary");
  const panelBody = document.getElementById("panelBody");
  const panelClose = document.getElementById("panelClose");

  function showTooltip(entry, x, y) {
    if (!entry) return;
    ttTitle.textContent = entry.title || entry.id;
    ttBody.textContent = entry.summary || "";
    tooltip.style.display = "block";
    const pad = 14;
    const rect = tooltip.getBoundingClientRect();
    let left = x + 12, top = y + 12;
    if (left + rect.width > window.innerWidth - pad) left = window.innerWidth - rect.width - pad;
    if (top + rect.height > window.innerHeight - pad) top = window.innerHeight - rect.height - pad;
    tooltip.style.left = left + "px";
    tooltip.style.top = top + "px";
  }
  function hideTooltip() { tooltip.style.display = "none"; }

  function openPanel(termId) {
    const entry = getWiki(termId);
    if (!entry) {
      panelTitle.textContent = "Unknown term";
      panelSummary.textContent = termId;
      panelBody.innerHTML = `<p>This term is not in the wiki dataset: <code>${escapeHtml(termId)}</code></p>`;
    } else {
      panelTitle.textContent = entry.title || entry.id;
      panelSummary.textContent = entry.summary || "";
      panelBody.innerHTML = renderWikiBody(entry.body || "");
    }
    panel.classList.add("open");
    panel.setAttribute("aria-hidden", "false");
  }
  function closePanel() {
    panel.classList.remove("open");
    panel.setAttribute("aria-hidden", "true");
  }
  panelClose.addEventListener("click", closePanel);

  // -----------------------------
  // App state + DOM refs
  // -----------------------------
  const state = {
    results: {},
    filter: "",
    mode: "slide",
    index: 0
  };

  const slideEl = document.getElementById("slide");
  const listCardsEl = document.getElementById("listCards");
  const dotsEl = document.getElementById("dots");
  const progressTextEl = document.getElementById("progressText");
  const scoreMiniEl = document.getElementById("scoreMini");
  const searchEl = document.getElementById("search");

  const slideView = document.getElementById("slideView");
  const listView = document.getElementById("listView");
  const modeSlideBtn = document.getElementById("modeSlide");
  const modeListBtn = document.getElementById("modeList");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  // Buttons
  const resetBtn = document.getElementById("reset");
  const openNanoDefBtn = document.getElementById("openNanoDef");

  function itemsFiltered() {
    const items = window.__NANO_DATA__.checklist || [];
    const q = (state.filter || "").trim().toLowerCase();
    if (!q) return items;
    return items.filter(it => {
      const combined = [
        it.title, it.what, it.why,
        ...(it.how_to_check || []),
        it.examples?.bad, it.examples?.good,
        ...(it.wiki_terms || []).map(t => getWiki(t)?.title || t)
      ].join(" ").toLowerCase();
      return combined.includes(q);
    });
  }

  function statusOf(id) { return state.results[id] || "unset"; }

  function setResult(id, value) {
    state.results[id] = value;
    renderAll();
  }

  function setMode(mode) {
    state.mode = mode;
    slideView.classList.toggle("active", mode === "slide");
    listView.classList.toggle("active", mode === "list");
    modeSlideBtn.classList.toggle("active", mode === "slide");
    modeListBtn.classList.toggle("active", mode === "list");
    renderAll();
  }

  function clampIndex() {
    const items = itemsFiltered();
    if (items.length === 0) { state.index = 0; return; }
    state.index = Math.max(0, Math.min(state.index, items.length - 1));
  }

  function gotoIndex(i) {
    state.index = i;
    clampIndex();
    renderAll();
  }

  function next() { gotoIndex(state.index + 1); }
  function prev() { gotoIndex(state.index - 1); }

  function renderDots() {
    const items = itemsFiltered();
    dotsEl.innerHTML = "";
    items.forEach((it, i) => {
      const d = document.createElement("div");
      d.className = "dot";
      const st = statusOf(it.id);
      if (st === "pass") d.classList.add("pass");
      if (st === "fail") d.classList.add("fail");
      if (i === state.index) d.classList.add("active");
      d.title = `${i+1}. ${it.title} (${st.toUpperCase()})`;
      d.addEventListener("click", () => gotoIndex(i));
      dotsEl.appendChild(d);
    });

    const total = items.length;
    const shown = total ? (state.index + 1) : 0;
    progressTextEl.innerHTML = `<span class="count"><strong>${shown}</strong> / ${total} checks</span>`;
  }

  function renderScoreMini() {
    const all = window.__NANO_DATA__.checklist || [];
    let pass = 0, fail = 0, unset = 0;
    for (const it of all) {
      const st = statusOf(it.id);
      if (st === "pass") pass++;
      else if (st === "fail") fail++;
      else unset++;
    }
    scoreMiniEl.innerHTML = `Pass: <strong>${pass}</strong> · Fail: <strong>${fail}</strong> · Unset: <strong>${unset}</strong> · Total: ${all.length}`;
  }

  function statusLabel(st) {
    if (st === "pass") return "PASS";
    if (st === "fail") return "FAIL";
    return "UNSET";
  }

  function renderSlide() {
    const items = itemsFiltered();
    if (items.length === 0) {
      slideEl.className = "slide";
      slideEl.innerHTML = `
        <div class="slide-header">
          <div class="slide-title">
            <h2>No matches</h2>
            <p class="what">Your search query does not match any checklist items.</p>
          </div>
          <div class="badges">
            <span class="pill">Try clearing the search.</span>
          </div>
        </div>
        <div class="slide-body">
          <div class="section">
            <span class="label">Tip</span>
            <p>Use short keywords like “focus”, “observable”, “schema”, “routing”.</p>
          </div>
        </div>
      `;
      return;
    }

    clampIndex();
    const it = items[state.index];
    const st = statusOf(it.id);

    const fixesHtml = (it.fixes || []).map(fx => {
      const opId = fx.operator;
      const opTitle = getWiki(opId)?.title || opId;
      return `<li>${termSpan(opId, opTitle)} — ${escapeHtml(fx.instruction || "")}</li>`;
    }).join("");

    const failIfHtml = (it.fail_if || []).map(x => `<li>${escapeHtml(x)}</li>`).join("");
    const howHtml = (it.how_to_check || []).map(x => `<li>${escapeHtml(x)}</li>`).join("");

    slideEl.className = `slide ${st === "pass" ? "pass" : st === "fail" ? "fail" : ""}`;

    slideEl.innerHTML = `
      <div class="slide-header">
        <div class="slide-title">
          <h2>${escapeHtml(it.title)}</h2>
          <p class="what">${escapeHtml(it.what)}</p>
        </div>
        <div class="badges">
          <span class="pill"><strong>Check</strong> ${escapeHtml(it.id)}</span>
          <span class="pill statusPill ${st}"><strong>Status</strong> ${statusLabel(st)}</span>
        </div>
      </div>

      <div class="slide-body">
        <div class="section">
          <span class="label">Why it matters</span>
          <p>${escapeHtml(it.why)}</p>
        </div>

        <div class="section">
          <span class="label">How to check</span>
          <ul class="list">${howHtml}</ul>
        </div>

        <div class="examples">
          <div class="example">
            <div class="exlabel"><span class="badge bad">Bad</span></div>
            <code>${escapeHtml(it.examples?.bad || "")}</code>
          </div>
          <div class="example">
            <div class="exlabel"><span class="badge good">Good</span></div>
            <code>${escapeHtml(it.examples?.good || "")}</code>
          </div>
        </div>

        <div class="section">
          <span class="label">Fail if</span>
          <ul class="list">${failIfHtml}</ul>
        </div>

        <div class="section">
          <span class="label">Fixes (operators)</span>
          <ul class="list">${fixesHtml || "<li>No fixes listed.</li>"}</ul>
          ${renderWikiChips(it.wiki_terms)}
        </div>

        <div class="actions">
          <div class="toggle" data-check="${escapeHtml(it.id)}">
            <button data-set="pass" class="${st==="pass" ? "active pass" : ""}">Pass</button>
            <button data-set="fail" class="${st==="fail" ? "active fail" : ""}">Fail</button>
            <button data-set="unset" class="${st==="unset" ? "active unset" : ""}">Unset</button>
            <span class="state">${st==="unset" ? "Unset" : ("Marked: " + st.toUpperCase())}</span>
          </div>
        </div>
      </div>
    `;

    slideEl.querySelectorAll("button[data-set]").forEach(btn => {
      btn.addEventListener("click", () => setResult(it.id, btn.getAttribute("data-set")));
    });

    prevBtn.disabled = (state.index <= 0);
    nextBtn.disabled = (state.index >= items.length - 1);
    prevBtn.style.opacity = prevBtn.disabled ? 0.55 : 1;
    nextBtn.style.opacity = nextBtn.disabled ? 0.55 : 1;
  }

  function renderList() {
    const items = itemsFiltered();
    listCardsEl.innerHTML = "";
    items.forEach((it, i) => {
      const st = statusOf(it.id);
      const card = document.createElement("article");
      card.className = `listCard ${st === "pass" ? "pass" : st === "fail" ? "fail" : ""}`;
      card.innerHTML = `
        <div class="slide-header" style="border-bottom: 1px solid rgba(230,237,243,0.08);">
          <div class="slide-title">
            <h2 style="font-size:16px">${escapeHtml(it.title)}</h2>
            <p class="what">${escapeHtml(it.what)}</p>
          </div>
          <div class="badges">
            <span class="pill statusPill ${st}"><strong>Status</strong> ${statusLabel(st)}</span>
            <button class="btn" data-go="${i}">Open</button>
          </div>
        </div>
      `;
      card.querySelector("button[data-go]").addEventListener("click", () => {
        setMode("slide");
        gotoIndex(i);
      });
      listCardsEl.appendChild(card);
    });
  }

  function renderAll() {
    renderDots();
    renderScoreMini();
    if (state.mode === "slide") renderSlide();
    else renderList();
  }

  // -----------------------------
  // Term interactions
  // -----------------------------
  let lastHoverTerm = null;

  function onPointerMove(e) {
    const t = e.target.closest?.("[data-term]");
    if (!t) {
      lastHoverTerm = null;
      hideTooltip();
      return;
    }
    const termId = t.getAttribute("data-term");
    if (!termId) return;

    if (termId !== lastHoverTerm) {
      lastHoverTerm = termId;
      const entry = getWiki(termId);
      if (entry) showTooltip(entry, e.clientX, e.clientY);
      else hideTooltip();
    } else {
      if (tooltip.style.display === "block") showTooltip(getWiki(termId), e.clientX, e.clientY);
    }
  }

  document.addEventListener("pointermove", onPointerMove);

  document.addEventListener("click", (e) => {
    const t = e.target.closest?.("[data-term]");
    if (!t) return;
    e.preventDefault();
    openPanel(t.getAttribute("data-term"));
  });

  // -----------------------------
  // Controls + navigation
  // -----------------------------
  searchEl.addEventListener("input", () => {
    state.filter = searchEl.value || "";
    state.index = 0;
    renderAll();
  });

  resetBtn.addEventListener("click", () => {
    state.results = {};
    state.filter = "";
    state.index = 0;
    searchEl.value = "";
    closePanel();
    renderAll();
  });

  openNanoDefBtn.addEventListener("click", () => {
    openPanel("concept_nano_task");
  });

  modeSlideBtn.addEventListener("click", () => setMode("slide"));
  modeListBtn.addEventListener("click", () => setMode("list"));

  prevBtn.addEventListener("click", prev);
  nextBtn.addEventListener("click", next);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closePanel();
    if (state.mode === "slide") {
      if (e.key === "ArrowLeft") prev();
      if (e.key === "ArrowRight") next();
    }
  });

  // -----------------------------
  // Bootstrap (load JSON then enable UI)
  // -----------------------------
  const loaderEl = document.getElementById("loader");

  function setControlsEnabled(enabled) {
    const all = [
      searchEl, openNanoDefBtn, resetBtn,
      prevBtn, nextBtn, modeSlideBtn, modeListBtn
    ];
    all.forEach(el => { el.disabled = !enabled; });
  }

  async function bootstrap() {
    try {
      setControlsEnabled(false);
      loaderEl.innerHTML = `Loading <code>data.json</code>…`;

      const data = await loadData();

      // Minimal structural validation
      if (!data || !data.checklist || !data.wiki) {
        throw new Error("data.json must contain top-level keys: checklist, wiki");
      }

      window.__NANO_DATA__ = data;

      // Reveal views, hide loader
      loaderEl.innerHTML = `<span class="ok">Loaded.</span> Rendering UI…`;
      document.getElementById("slideView").style.display = "";
      document.getElementById("listView").style.display = "";
      loaderEl.style.display = "none";

      setControlsEnabled(true);
      renderAll();
    } catch (err) {
      console.error(err);
      setControlsEnabled(false);
      loaderEl.innerHTML = `
        <div class="err"><strong>Failed to load data.json</strong></div>
        <div style="margin-top:8px">Error: <code>${escapeHtml(err.message || String(err))}</code></div>
        <div style="margin-top:10px">
          Make sure <code>data.json</code> is in the same folder as this HTML file.
          If you host on GitHub Pages under a subpath, keep the fetch URL relative (<code>./data.json</code>).
        </div>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", bootstrap);
</script>
</body>
</html>
